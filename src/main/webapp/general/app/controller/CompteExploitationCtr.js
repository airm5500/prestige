/* global Ext */

Ext.define('testextjs.controller.CompteExploitationCtr', {
    extend: 'Ext.app.Controller',
    views: ['testextjs.view.Dashboard.CompteExploitation'],
    refs: [{
            ref: 'compteExploitation',
            selector: 'compteExploitation'
        },
        {
            ref: 'imprimerBtn',
            selector: 'compteExploitation #imprimer'
        }

        , {
            ref: 'dtStart',
            selector: 'compteExploitation #dtStart'
        }, {
            ref: 'dtEnd',
            selector: 'compteExploitation #dtEnd'
        },
        {ref: 'rechercherButton',
            selector: 'compteExploitation #rechercher'

        },

        {
            ref: 'especeVeto',
            selector: 'compteExploitation #especeVeto'
        },

        {
            ref: 'creditVeto',
            selector: 'compteExploitation #creditVeto'
        },
        {
            ref: 'totalEspece',
            selector: 'compteExploitation #totalEspece'
        },
        {
            ref: 'espece',
            selector: 'compteExploitation #espece'
        },

        {
            ref: 'credit',
            selector: 'compteExploitation #credit'
        },
        {
            ref: 'totalCredit',
            selector: 'compteExploitation #totalCredit'
        },
        {
            ref: 'totalRemise',
            selector: 'compteExploitation #totalRemise'
        },
        {
            ref: 'totalTVA',
            selector: 'compteExploitation #totalTVA'
        },
        {
            ref: 'totalCaHT',
            selector: 'compteExploitation #totalCaHT'
        },
        {
            ref: 'totalCaTTC',
            selector: 'compteExploitation #totalCaTTC'
        }

    ],
    init: function (application) {
        this.control({

            'compteExploitation #rechercher': {
                click: this.doSearch
            },
            'compteExploitation #imprimer': {
                click: this.onPdfClick
            }

        });
    },

    onPdfClick: function () {
        let me = this;
        let dtStart = me.getDtStart().getSubmitValue();
        let dtEnd = me.getDtEnd().getSubmitValue();
        var linkUrl = '../DataReportingServlet?mode=COMPTE_EXPLOITATION&dtStart=' + dtStart + '&dtEnd=' + dtEnd;
        window.open(linkUrl);
    },

    doSearch: function () {
        let me = this;
        let  dtStart = me.getDtStart().getSubmitValue();
        let  dtEnd = me.getDtEnd().getSubmitValue();
        var progress = Ext.MessageBox.wait('Veuillez patienter . . .', 'En cours de traitement!');
        Ext.Ajax.request({
            method: 'GET',
            url: '../api/v1/compteexploitation',
            params: {
                "dtStart": dtStart,
                "dtEnd": dtEnd
            },
            success: function (response, options) {
                var data = Ext.JSON.decode(response.responseText, true);
                progress.hide();
                let totalEspec = data.espece + data.especeVeto;
                let totalCredit = data.creditVeto + data.credit;
                me.getEspece().setValue(data.espece);
                me.getEspeceVeto().setValue(data.especeVeto);
                me.getTotalEspece().setValue(totalEspec);
                me.getCredit().setValue(data.credit);
                me.getCreditVeto().setValue(data.creditVeto);
                me.getTotalCredit().setValue(totalCredit);
                me.getTotalCaTTC().setValue(data.totalCaTTC);
                me.getTotalCaHT().setValue(data.totalCaHT);
                me.getTotalTVA().setValue(data.totalTVA);
                me.getTotalRemise().setValue(data.totalRemise);


            },
            failure: function (response, options) {
                progress.hide();
                Ext.Msg.alert("Message", 'Erreur du serveur ' + response.status);
            }

        });

    }

});